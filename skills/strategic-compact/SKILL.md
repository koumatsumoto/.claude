---
name: strategic-compact
description: 任意の自動コンパクトではなく、論理的な区切りで手動 /compact を提案し、フェーズ間の文脈を保持する。
---

# 戦略的コンパクトスキル

任意の自動コンパクトに頼るのではなく、ワークフロー上の適切なタイミングで手動 `/compact` を提案する。

## なぜ戦略的コンパクト？

自動コンパクトは任意のタイミングで発生する:

- タスク途中で起きやすく、重要文脈が欠落
- 論理的な区切りを認識しない
- 複雑な多段タスクを中断しやすい

論理境界でのコンパクトは:

- **探索後・実行前** - 調査文脈を圧縮し、実装計画を残す
- **マイルストーン完了後** - 次フェーズを新鮮な状態で開始
- **大きな文脈転換前** - これまでの探索を整理して次へ

## 仕組み

`suggest-compact.sh` は PreToolUse（Edit/Write）で実行され、以下を行う:

1. **ツール呼び出し追跡** - セッション内のツール呼び出し回数をカウント
2. **閾値検出** - 設定閾値（デフォルト 50）で提案
3. **定期リマインド** - 以後 25 回ごとに提案

## フック設定

`~/.claude/settings.json` に追加:

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "tool == \"Edit\" || tool == \"Write\"",
        "hooks": [
          {
            "type": "command",
            "command": "~/.claude/skills/strategic-compact/suggest-compact.sh"
          }
        ]
      }
    ]
  }
}
```

## 設定

環境変数:

- `COMPACT_THRESHOLD` - 初回提案までのツール回数（デフォルト 50）

## ベストプラクティス

1. **計画の後にコンパクト** - 計画が確定したら整理
2. **デバッグ後にコンパクト** - 解決した文脈を整理
3. **実装途中ではコンパクトしない** - 文脈を維持
4. **提案を読む** - いつやるかは人が判断

## 関連

- [ロングガイド](https://x.com/affaanmustafa/status/2014040193557471352) - トークン最適化
- Memory persistence hooks - コンパクト後も状態保持
